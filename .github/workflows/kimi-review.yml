name: Kimi Code Review

on:
  pull_request:
    types: [opened, ready_for_review, synchronize]
  issue_comment:
    types: [created]

jobs:
  kimi-review:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@kimi re-review'))
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}

      - name: Get PR Diff
        id: get-diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          gh pr diff "$PR_NUMBER" --repo "${{ github.repository }}" > pr_diff.txt
          echo "diff_length=$(wc -c < pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: Run Kimi Code Review
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          REPO="${{ github.repository }}"

          # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          PR_TITLE=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json title -q '.title')
          PR_BODY=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json body -q '.body')

          # diff íŒŒì¼ ì½ê¸° (ìµœëŒ€ 100KB ì œí•œ)
          DIFF_CONTENT=$(head -c 100000 pr_diff.txt)

          # jqë¡œ JSON ì•ˆì „í•˜ê²Œ êµ¬ì„±
          REQUEST_BODY=$(jq -n \
            --arg pr_title "$PR_TITLE" \
            --arg pr_body "$PR_BODY" \
            --arg diff "$DIFF_CONTENT" \
            '{
              model: "moonshotai/kimi-k2.5",
              messages: [
                {
                  role: "system",
                  content: "ë‹¹ì‹ ì€ ì‹¤ìš©ì ì¸ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ê°„ê²°í•˜ê²Œ ë¦¬ë·°í•˜ì„¸ìš”.\n\nì¤‘ì  í™•ì¸ ì‚¬í•­:\n- ì‹¤ì œ ë²„ê·¸ë‚˜ ëŸ°íƒ€ì„ ì—ëŸ¬ ê°€ëŠ¥ì„±\n- ëª…ë°±í•œ ì„±ëŠ¥ ë¬¸ì œ\n- Next.js/React ì•ˆí‹°íŒ¨í„´\n\nì£¼ì˜ ì‚¬í•­:\n- ì´ë¡ ì ìœ¼ë¡œë§Œ ê°€ëŠ¥í•œ ì—£ì§€ ì¼€ì´ìŠ¤ëŠ” ë¬´ì‹œ\n- ê³¼ë„í•œ ì—ëŸ¬ í•¸ë“¤ë§ì´ë‚˜ ë°©ì–´ ì½”ë”©ì„ ì œì•ˆí•˜ì§€ ë§ˆì„¸ìš”\n- ë¬¸ì œê°€ ì—†ìœ¼ë©´ íŠ¹ì´ì‚¬í•­ ì—†ìŒìœ¼ë¡œ ì§§ê²Œ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”"
                },
                {
                  role: "user",
                  content: ("PR ì œëª©: " + $pr_title + "\n\nPR ì„¤ëª…: " + $pr_body + "\n\nì½”ë“œ ë³€ê²½ì‚¬í•­:\n\n" + $diff)
                }
              ],
              temperature: 0.3,
              max_tokens: 4000
            }')

          # OpenRouter API í˜¸ì¶œ (Kimi K2.5)
          REVIEW_RESPONSE=$(curl -s -X POST \
            https://openrouter.ai/api/v1/chat/completions \
            -H "Authorization: Bearer $OPENROUTER_API_KEY" \
            -H "Content-Type: application/json" \
            -H "HTTP-Referer: https://github.com/$REPO" \
            -H "X-Title: Kimi Code Review" \
            -d "$REQUEST_BODY")

          # ì‘ë‹µì—ì„œ ë¦¬ë·° ë‚´ìš© ì¶”ì¶œ
          REVIEW_CONTENT=$(echo "$REVIEW_RESPONSE" | jq -r '.choices[0].message.content // "ë¦¬ë·° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."')

          # GitHub PRì— ì½”ë©˜íŠ¸ ì‘ì„±
          printf "## ğŸ¤– Kimi Code Review (via OpenRouter)\n\n%s\n\n---\n*Powered by Moonshot AI (kimi-k2.5) via OpenRouter*" "$REVIEW_CONTENT" | gh pr comment "$PR_NUMBER" --repo "$REPO" --body-file -

      - name: Cleanup
        if: always()
        run: rm -f pr_diff.txt
