name: Kimi Code Review

on:
  pull_request:
    types: [opened, ready_for_review, synchronize]
  issue_comment:
    types: [created]

jobs:
  kimi-review:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@kimi re-review'))
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'issue_comment' && format('refs/pull/{0}/head', github.event.issue.number) || github.ref }}

      - name: Get PR Diff
        id: get-diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          gh pr diff "$PR_NUMBER" --repo "${{ github.repository }}" > pr_diff.txt
          echo "diff_length=$(wc -c < pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: Run Kimi Code Review
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.event.issue.number }}"
          REPO="${{ github.repository }}"

          # PR ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          PR_TITLE=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json title -q '.title')
          PR_BODY=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json body -q '.body')

          # diff íŒŒì¼ ì½ê¸° (ìµœëŒ€ 100KB ì œí•œ)
          DIFF_CONTENT=$(head -c 100000 pr_diff.txt)

          # OpenRouter API í˜¸ì¶œ (Kimi K2.5)
          REVIEW_RESPONSE=$(curl -s -X POST \
            https://openrouter.ai/api/v1/chat/completions \
            -H "Authorization: Bearer $OPENROUTER_API_KEY" \
            -H "Content-Type: application/json" \
            -H "HTTP-Referer: https://github.com/$REPO" \
            -H "X-Title: Kimi Code Review" \
            -d "{
              \"model\": \"moonshotai/kimi-k2.5\",
              \"messages\": [
                {
                  \"role\": \"system\",
                  \"content\": \"ë‹¹ì‹ ì€ ì½”ë“œ ë¦¬ë·°ì–´ì…ë‹ˆë‹¤. í•œêµ­ì–´ë¡œ ì½”ë“œ ë¦¬ë·°ë¥¼ ì œê³µí•˜ì„¸ìš”. ì½”ë“œ í’ˆì§ˆ, ì ì¬ì  ë²„ê·¸, ì„±ëŠ¥ ì´ìŠˆ, ë³´ì•ˆ ì·¨ì•½ì , ê·¸ë¦¬ê³  Next.js/React ëª¨ë²” ì‚¬ë¡€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\"
                },
                {
                  \"role\": \"user\",
                  \"content\": \"PR ì œëª©: $PR_TITLE\\n\\nPR ì„¤ëª…: $PR_BODY\\n\\nì½”ë“œ ë³€ê²½ì‚¬í•­:\\n\\n$DIFF_CONTENT\"
                }
              ],
              \"temperature\": 0.3,
              \"max_tokens\": 4000
            }")

          # ì‘ë‹µì—ì„œ ë¦¬ë·° ë‚´ìš© ì¶”ì¶œ
          REVIEW_CONTENT=$(echo "$REVIEW_RESPONSE" | jq -r '.choices[0].message.content // "ë¦¬ë·° ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."')

          # GitHub PRì— ì½”ë©˜íŠ¸ ì‘ì„±
          printf "## ğŸ¤– Kimi Code Review (via OpenRouter)\n\n%s\n\n---\n*Powered by Moonshot AI (kimi-k2.5) via OpenRouter*" "$REVIEW_CONTENT" | gh pr comment "$PR_NUMBER" --repo "$REPO" --body-file -

      - name: Cleanup
        if: always()
        run: rm -f pr_diff.txt
